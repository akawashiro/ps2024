// #include <stdio.h>
//
// void put_whitespace(char c) {
//   if (c == ' ') {
//     printf("[SP]");
//   } else if (c == '\t') {
//     printf("[TAB]");
//   } else if (c == '\n') {
//     printf("[LF]");
//   } else {
//     printf("[Not whitespace: %d]", c);
//   }
// }
//
// void dump(char *head) {
//   while (*head) {
//     put_whitespace(*head);
//     head++;
//   }
//   printf("\n");
// }
//
// int parse_number(char **head_p) {
//   char *head = *head_p;
//
//   int flag = 0;
//   {
//     char c = *head;
//     head++;
//     if (c == ' ') {
//       flag = 1;
//     } else if (c == '\t') {
//       flag = -1;
//     }
//   }
//
//   int num = 0;
//   while (1) {
//     char c = *head;
//     head++;
//
//     if (c == ' ') {
//       num = num * 2 + 0;
//     } else if (c == '\t') {
//       num = num * 2 + 1;
//     } else {
//       break;
//     }
//   }
//
//   *head_p = head;
//   return num;
// }

char whitespace_program[] = {
    0x20, 0x20, 0x20, 0x09, 0x20, 0x20, 0x09, 0x20, 0x20, 0x20, 0x0a, 0x09,
    0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x09, 0x09, 0x20, 0x20, 0x09, 0x20,
    0x09, 0x0a, 0x09, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x09, 0x09, 0x20,
    0x09, 0x09, 0x20, 0x20, 0x0a, 0x09, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20,
    0x09, 0x09, 0x20, 0x09, 0x09, 0x20, 0x20, 0x0a, 0x09, 0x0a, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x09, 0x09, 0x20, 0x09, 0x09, 0x09, 0x09, 0x0a, 0x09,
    0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x09, 0x20, 0x09, 0x09, 0x20, 0x20,
    0x0a, 0x09, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x09, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x0a, 0x09, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x09, 0x09,
    0x09, 0x20, 0x09, 0x09, 0x09, 0x0a, 0x09, 0x0a, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x09, 0x09, 0x20, 0x09, 0x09, 0x09, 0x09, 0x0a, 0x09, 0x0a, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x09, 0x09, 0x09, 0x20, 0x20, 0x09, 0x20, 0x0a,
    0x09, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x09, 0x09, 0x20, 0x09, 0x09,
    0x20, 0x20, 0x0a, 0x09, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x09, 0x09,
    0x20, 0x20, 0x09, 0x20, 0x20, 0x0a, 0x09, 0x0a, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x09, 0x20, 0x20, 0x20, 0x20, 0x09, 0x0a, 0x09, 0x0a, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x09, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0a, 0x09, 0x0a,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x09, 0x09, 0x20, 0x20, 0x09, 0x09, 0x20,
    0x0a, 0x09, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x09, 0x09, 0x09, 0x20,
    0x20, 0x09, 0x20, 0x0a, 0x09, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x09,
    0x09, 0x20, 0x09, 0x09, 0x09, 0x09, 0x0a, 0x09, 0x0a, 0x20, 0x20, 0x20,
    0x20, 0x20, 0x09, 0x09, 0x20, 0x09, 0x09, 0x20, 0x09, 0x0a, 0x09, 0x0a,
    0x20, 0x20, 0x20, 0x20, 0x20, 0x09, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0a,
    0x09, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x09, 0x09, 0x09, 0x20, 0x09,
    0x09, 0x09, 0x0a, 0x09, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x09, 0x09,
    0x20, 0x09, 0x20, 0x20, 0x20, 0x0a, 0x09, 0x0a, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x09, 0x09, 0x20, 0x09, 0x20, 0x20, 0x09, 0x0a, 0x09, 0x0a, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x09, 0x09, 0x09, 0x20, 0x09, 0x20, 0x20, 0x0a,
    0x09, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x09, 0x09, 0x20, 0x20, 0x09,
    0x20, 0x09, 0x0a, 0x09, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x09, 0x09,
    0x09, 0x20, 0x20, 0x09, 0x09, 0x0a, 0x09, 0x0a, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x09, 0x09, 0x09, 0x20, 0x20, 0x20, 0x20, 0x0a, 0x09, 0x0a, 0x20,
    0x20, 0x20, 0x20, 0x20, 0x09, 0x09, 0x20, 0x20, 0x20, 0x20, 0x09, 0x0a,
    0x09, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x09, 0x09, 0x20, 0x20, 0x20,
    0x09, 0x09, 0x0a, 0x09, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x09, 0x09,
    0x20, 0x20, 0x09, 0x20, 0x09, 0x0a, 0x09, 0x0a, 0x20, 0x20, 0x20, 0x20,
    0x20, 0x09, 0x20, 0x20, 0x20, 0x20, 0x09, 0x0a, 0x09, 0x0a, 0x20, 0x20,
    0x20, 0x20, 0x20, 0x09, 0x20, 0x09, 0x20, 0x0a, 0x09, 0x0a, 0x20, 0x20,
    0x0a, 0x0a, 0x0a};

void run_whitespace() {
  // Buffer to print without libc
  char print_buf[16];

  // Stack for the whitespace program
  int stack[1024];
  int stack_ptr = 0;

  // char *head = whitespace_program;
  char *head = 0x400100;
  while (*head) {
    if (*head == ' ') {
      head++;
      // IMP: Stack
      if (*head == ' ') {
        head++;
        // Command: Push
        int num = 0;
        // Parse number
        {
          int flag = 0;
          {
            char c = *head;
            head++;
            if (c == ' ') {
              flag = 1;
            } else if (c == '\t') {
              flag = -1;
            }
          }

          while (1) {
            char c = *head;
            head++;

            if (c == ' ') {
              num = num * 2 + 0;
            } else if (c == '\t') {
              num = num * 2 + 1;
            } else {
              break;
            }
          }
        }
        stack[stack_ptr] = num;
        stack_ptr++;
      } else {
        // Unsupported COMMAND
        return;
      }
    } else if (*head == '\t' && *(head + 1) == '\n') {
      head += 2;
      // IMP: IO
      if (*head == ' ' && *(head + 1) == ' ') {
        head += 2;
        // COMMAND: Output
        stack_ptr--;
        print_buf[0] = stack[stack_ptr];
        print_buf[1] = '\0';
        __asm__ volatile("syscall" : : "a"(1), "D"(1), "S"(print_buf), "d"(1));
      } else {
        // Unsupported COMMAND
        break;
      }
    } else if (*head == '\n' && *(head + 1) == '\n' && *(head + 2) == '\n') {
      // IMP: Control
      // COMMAND: End
      break;
    } else {
      // Unsupported IMP
      break;
    }
  }

  __asm__ volatile("mov $0x401000, %rax");
  __asm__ volatile("jmp *%rax");
}

int main() { run_whitespace(); }
